name: build-macos

on:
  workflow_dispatch:

jobs:
  sanity:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: arm64
            runs_on: macos-14
          - name: x86_64
            runs_on: macos-15-intel

    runs-on: ${{ matrix.runs_on }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print base environment
        shell: bash
        run: |
          set -euxo pipefail
          echo "arch: $(uname -m)"
          sw_vers
          xcodebuild -version
          clang --version

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure Homebrew
        shell: bash
        run: |
          set -euxo pipefail
          if ! command -v brew >/dev/null; then
            /bin/bash -lc "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi

          if [ -x /opt/homebrew/bin/brew ]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
          else
            eval "$(/usr/local/bin/brew shellenv)"
          fi

          brew update
          brew --version

      - name: Install build tools (cmake, ninja) - link-safe
        shell: bash
        run: |
          set -euxo pipefail

          brew install cmake ninja

          echo "Tool versions:"
          cmake --version
          ninja --version

          echo "Python versions:"
          which python
          python --version
          which python3
          python3 --version
