name: build-macos

on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: arm64
            runs_on: macos-14
          - name: x86_64
            runs_on: macos-15-intel

    runs-on: ${{ matrix.runs_on }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Base environment
        shell: bash
        run: |
          set -euxo pipefail
          echo "arch: $(uname -m)"
          sw_vers
          xcodebuild -version
          clang --version
          zsh --version

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure Homebrew
        shell: bash
        run: |
          set -euxo pipefail
          if ! command -v brew >/dev/null; then
            /bin/bash -lc "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
          if [ -x /opt/homebrew/bin/brew ]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
          else
            eval "$(/usr/local/bin/brew shellenv)"
          fi
          brew update
          brew --version

      # IMPORTANT FIX: Install CMake.app to /Applications before linking.
      # If you link while mounted, the symlinks point at /Volumes/... and break after detach.
      - name: Install CMake 3.31.7 (per OpenRV macOS docs)
        shell: bash
        run: |
          set -euxo pipefail

          CMAKE_DMG_URL="https://github.com/Kitware/CMake/releases/download/v3.31.7/cmake-3.31.7-macos-universal.dmg"
          curl -L "$CMAKE_DMG_URL" -o /tmp/cmake.dmg

          MOUNT_POINT="$(hdiutil attach /tmp/cmake.dmg | awk 'END{print $3}')"
          sudo rm -rf /Applications/CMake.app
          sudo cp -R "$MOUNT_POINT/CMake.app" /Applications/CMake.app
          hdiutil detach "$MOUNT_POINT"

          # Put CMake.app binaries on PATH (no fragile /usr/local symlinks needed)
          echo "/Applications/CMake.app/Contents/bin" >> "$GITHUB_PATH"
          cmake --version

      - name: Install macOS build dependencies (CY2024 list, except Qt)
        shell: bash
        run: |
          set -euxo pipefail
          brew install \
            ninja readline sqlite3 xz zlib tcl-tk@8 \
            autoconf automake libtool \
            yasm clang-format black meson nasm pkg-config glew rust
          ninja --version
          rustc --version || true

      - name: Install Qt 6.5.3 (aqtinstall) and set QT_HOME
        shell: bash
        run: |
          set -euxo pipefail

          python -m pip install --upgrade pip
          python -m pip install "aqtinstall>=3.2.0"

          QT_DIR="$HOME/Qt"
          mkdir -p "$QT_DIR"

          aqt install-qt mac desktop 6.5.3 clang_64 -O "$QT_DIR"

          if [ -d "$QT_DIR/6.5.3/macos" ]; then
            echo "QT_HOME=$QT_DIR/6.5.3/macos" >> "$GITHUB_ENV"
          elif [ -d "$QT_DIR/6.5.3/clang_64" ]; then
            echo "QT_HOME=$QT_DIR/6.5.3/clang_64" >> "$GITHUB_ENV"
          else
            echo "ERROR: Qt install path not found. Contents:"
            find "$QT_DIR" -maxdepth 4 -type d | sed -n '1,200p'
            exit 1
          fi

      - name: Build OpenRV (rvbootstrap via rvcmds.sh)
        shell: bash
        run: |
          set -euxo pipefail

          zsh -lc '
            set -euo pipefail
            export QT_HOME="'"$QT_HOME"'"
            echo "Using QT_HOME=$QT_HOME"
            source ./rvcmds.sh
            rvbootstrap
          '

      - name: Verify output exists
        shell: bash
        run: |
          set -euxo pipefail
          test -f "_build/stage/app/RV.app/Contents/MacOS/RV"
          ls -la "_build/stage/app/RV.app/Contents/MacOS" | sed -n '1,200p'

      - name: Package RV.app
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p artifacts
          ditto -c -k --sequesterRsrc --keepParent "_build/stage/app/RV.app" "artifacts/RV-${{ matrix.name }}.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openrv-macos-${{ matrix.name }}
          path: artifacts/RV-${{ matrix.name }}.zip
