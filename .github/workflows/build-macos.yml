name: build-macos

on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: arm64
            runs_on: macos-14
          - name: x86_64
            runs_on: macos-15-intel

    runs-on: ${{ matrix.runs_on }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Base environment
        shell: bash
        run: |
          set -euxo pipefail
          echo "arch: $(uname -m)"
          sw_vers
          echo "zsh: $(zsh --version)"
          xcodebuild -version
          clang --version

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure Homebrew
        shell: bash
        run: |
          set -euxo pipefail
          if ! command -v brew >/dev/null; then
            /bin/bash -lc "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
          if [ -x /opt/homebrew/bin/brew ]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
          else
            eval "$(/usr/local/bin/brew shellenv)"
          fi
          brew update
          brew --version

      - name: Install build tools (cmake, ninja)
        shell: bash
        run: |
          set -euxo pipefail
          brew install cmake ninja
          cmake --version
          ninja --version
          python --version

      - name: Build OpenRV (run zsh init then scripts)
        shell: bash
        run: |
          set -euxo pipefail

          # Run the zsh-oriented env init + build in one zsh login shell
          zsh -lc '
            set -euo pipefail

            if [ -f "./rvcmds.sh" ]; then
              echo "Initializing env with rvcmds.sh (zsh)"
              source ./rvcmds.sh
            fi

            if [ -x "./rvbootstrap" ] || [ -f "./rvbootstrap" ]; then
              echo "Running ./rvbootstrap"
              ./rvbootstrap
            else
              echo "ERROR: rvbootstrap not found at repo root."
              ls -la
              exit 1
            fi

            if [ -x "./rvmk" ] || [ -f "./rvmk" ]; then
              echo "Running ./rvmk"
              ./rvmk
            else
              echo "ERROR: rvmk not found at repo root."
              ls -la
              exit 1
            fi
          '

      - name: Package stage (if present)
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p artifacts

          if [ -d "_build/stage" ]; then
            tar -czf "artifacts/openrv-macos-${{ matrix.name }}-stage.tar.gz" -C "_build" stage
          elif [ -d "_build" ]; then
            tar -czf "artifacts/openrv-macos-${{ matrix.name }}-_build.tar.gz" -C "." _build
          else
            echo "ERROR: No _build directory produced."
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openrv-macos-${{ matrix.name }}
          path: artifacts/*
