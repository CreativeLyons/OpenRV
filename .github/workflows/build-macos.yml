name: build-macos

on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: arm64
            runs_on: macos-14
          - name: x86_64
            runs_on: macos-15-intel

    runs-on: ${{ matrix.runs_on }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Base environment
        shell: bash
        run: |
          set -euxo pipefail
          echo "arch: $(uname -m)"
          sw_vers
          xcodebuild -version
          clang --version

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure Homebrew
        shell: bash
        run: |
          set -euxo pipefail
          if ! command -v brew >/dev/null; then
            /bin/bash -lc "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
          if [ -x /opt/homebrew/bin/brew ]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
          else
            eval "$(/usr/local/bin/brew shellenv)"
          fi
          brew update
          brew --version

      - name: Install build tools (cmake, ninja)
        shell: bash
        run: |
          set -euxo pipefail
          brew install cmake ninja
          cmake --version
          ninja --version
          python --version

      - name: Build OpenRV (repo scripts)
        shell: bash
        run: |
          set -euxo pipefail

          # Try common OpenRV entrypoints; fail with a clear message if none exist.
          if [ -f "./rvcmds.sh" ]; then
            echo "Using rvcmds.sh flow"
            source ./rvcmds.sh
            rvbootstrap
            rvmk
          elif [ -f "./rvbootstrap" ]; then
            echo "Using ./rvbootstrap + ./rvmk"
            ./rvbootstrap
            ./rvmk
          else
            echo "ERROR: Could not find OpenRV build entrypoints (rvcmds.sh/rvbootstrap)."
            echo "List repo root:"
            ls -la
            exit 1
          fi

      - name: Package stage (if present)
        shell: bash
        run: |
          set -euxo pipefail

          mkdir -p artifacts

          if [ -d "_build/stage" ]; then
            echo "Found _build/stage"
            tar -czf "artifacts/openrv-macos-${{ matrix.name }}-stage.tar.gz" -C "_build" stage
          elif [ -d "_build" ]; then
            echo "No stage folder; archiving _build (fallback)"
            tar -czf "artifacts/openrv-macos-${{ matrix.name }}-_build.tar.gz" -C "." _build
          else
            echo "ERROR: No _build directory produced."
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openrv-macos-${{ matrix.name }}
          path: artifacts/*
